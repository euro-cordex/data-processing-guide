<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Memory Management &#8212; REMO Documentation and User Guide 0 documentation</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html"><span><img src="_static/REMO_logo.png"></span>
          REMO</a>
        <span class="navbar-text navbar-version pull-left"><b>2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="http://remo-rcm.de">Homepage</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="syntax-examples.html">1. Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="syntax-examples.html#headings">1.1. Headings</a></li>
<li class="toctree-l2"><a class="reference internal" href="syntax-examples.html#code">1.2. Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="syntax-examples.html#admonitions">1.3. Admonitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="syntax-examples.html#footnotes">1.4. Footnotes</a></li>
<li class="toctree-l2"><a class="reference internal" href="syntax-examples.html#icons">1.5. Icons</a></li>
<li class="toctree-l2"><a class="reference internal" href="syntax-examples.html#tables">1.6. Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="syntax-examples.html#code-documentation">1.7. Code Documentation</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Memory Management</a><ul>
<li><a class="reference internal" href="#in-and-output-streams">In and Output Streams</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="_sources/memory.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="memory-management">
<span id="cha-memory"></span><h1>Memory Management<a class="headerlink" href="#memory-management" title="Permalink to this headline">Â¶</a></h1>
<p>The new REMO version contains a new concept for managing fields and
allocating data based on ECHAM6. The concept is based on memory streams
which are lists of derived types that contain meta data and a pointer
that holds the actual data in the memory. Such a derived type is called
<code class="docutils literal notranslate"><span class="pre">memory_info</span></code> and it is defined in <code class="docutils literal notranslate"><span class="pre">mo_linked_list.f90</span></code>. Here is a
short excerpt from the meta data</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TYPE memory_info                      ! meta data type

    !
    SEQUENCE
    !
    ! Content of the field
    !
    CHARACTER(len= 64) :: name          ! variable name
    CHARACTER(len= 64) :: units         ! units
    CHARACTER(len=128) :: longname      ! long name
    !
    ! Memory buffer information
    !
    INTEGER            :: ldim(4)       ! local dimensions (lon,lat)
    INTEGER            :: gdim(4)       ! global dimensions of variable
    INTEGER            :: dima(4)       ! allocated dimensions (nproma,ngpblks)
    LOGICAL            :: lreg          ! true for dim==dima
    INTEGER            :: ndim          ! nr physical dimensions
    INTEGER            :: rank          ! rank of data
    INTEGER            :: klev          ! number of vertical levels
    INTEGER            :: iklev         ! vertical level index
    INTEGER            :: ltype         ! ltype
    INTEGER            :: kake(2)       ! first and last level index

    .....

  END TYPE memory_info
</pre></div>
</div>
<p>The derived type <code class="docutils literal notranslate"><span class="pre">memory_type</span></code> contains a variable <code class="docutils literal notranslate"><span class="pre">info</span></code> of type
<code class="docutils literal notranslate"><span class="pre">memory_info</span></code> and a 4D pointer which can be allocated to hold data in
the memory. It looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!
! Type &#39;memory_type&#39; holds the pointer to the field as well as the meta
! associated information.
!
TYPE memory_type                         ! linked list entry type
  !
  SEQUENCE
  !
  REAL(dp), POINTER   :: ptr (:,:,:,:)  ! pointer to 3D-field
  TYPE (memory_info)  :: info           ! meta data for this entry
END TYPE memory_type
!
</pre></div>
</div>
<p>The derived type <code class="docutils literal notranslate"><span class="pre">list_element</span></code> contains a variable <code class="docutils literal notranslate"><span class="pre">field</span></code> of type
<code class="docutils literal notranslate"><span class="pre">memory_type</span></code> and a reference to the next list element called
<code class="docutils literal notranslate"><span class="pre">next_list_element</span></code> which is also of type <code class="docutils literal notranslate"><span class="pre">list_element</span></code>. It looks
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!
! Type &#39;list_element&#39; provides the entry to the actual information
! and a reference to the next element in the list.
!
TYPE list_element
  !
  SEQUENCE
  !
  TYPE (memory_type)          :: field
  TYPE(list_element), POINTER :: next_list_element
END TYPE list_element
!
</pre></div>
</div>
<div class="line-block">
<div class="line">All routines that manage field data and list elements are implemented
in <code class="docutils literal notranslate"><span class="pre">mo_memory_base.f90</span></code>. However, the user usually does not have to
care about how streams and stream elements are handled. The user can
simply work with a variable that points to the address where memory is
allocated for this variable.</div>
<div class="line">For example, fields that are part of the main REMO table are declared
in <code class="docutils literal notranslate"><span class="pre">mo_memory_main.f90</span></code>. A variable for the temperature is declared
in the data section of the Fortran module like this and a stream for
the main REMO table which is of type <code class="docutils literal notranslate"><span class="pre">t_stream</span></code></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span><span class="p">(</span><span class="n">t_stream</span><span class="p">)</span>          <span class="p">,</span> <span class="n">POINTER</span> <span class="p">::</span>  <span class="n">REMO_TABLE</span>
<span class="n">REAL</span><span class="p">,</span> <span class="n">DIMENSION</span><span class="p">(:,:,:,:),</span> <span class="n">POINTER</span> <span class="p">::</span>  <span class="n">T</span>
</pre></div>
</div>
<p>The module also contains a subroutine called <code class="docutils literal notranslate"><span class="pre">construct_remo_table</span></code>
which is called in the <code class="docutils literal notranslate"><span class="pre">init_memory</span></code> subroutine in
<code class="docutils literal notranslate"><span class="pre">mo_memory_streams.f90</span></code> during the model initialization. This
subroutine constructs the main REMO table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!
!  create main stream called REMO_TABLE
!
CALL new_stream(REMO_TABLE, name=&#39;REMO_TABLE&#39;)
!
</pre></div>
</div>
<p>and after adding this new stream, all variables are added to the stream
including, e.g., the temperature:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CALL</span> <span class="n">add</span><span class="p">(</span><span class="n">REMO_TABLE</span><span class="p">,</span> <span class="s1">&#39;T       &#39;</span><span class="p">,</span> <span class="n">T</span>       <span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">130</span><span class="p">,</span> <span class="n">adims</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">IE</span><span class="p">,</span><span class="n">JE</span><span class="p">,</span><span class="n">KE</span> <span class="p">,</span><span class="mi">3</span><span class="o">/</span><span class="p">),</span> <span class="n">leveltype</span><span class="o">=</span><span class="mi">110</span><span class="p">,</span> <span class="n">gbtri</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">kake</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span>  <span class="p">,</span><span class="n">KE</span> <span class="o">/</span><span class="p">),</span> <span class="n">ntime</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>The subroutine <code class="docutils literal notranslate"><span class="pre">add(_stream_element)</span></code> in <code class="docutils literal notranslate"><span class="pre">mo_memory_base.f90</span></code>) will
add a new list element to the stream called <code class="docutils literal notranslate"><span class="pre">REMO_TABLE</span></code> and will
allocate memory based on the argument <code class="docutils literal notranslate"><span class="pre">adims</span></code>. For example, the
temperature is allocated as a 3D field with 3 time dimensions since it
is a dynamic variable on all model levels. The subroutine
<code class="docutils literal notranslate"><span class="pre">add_stream_elements</span></code> allows for a lot more arguments where most is
them is set by default. However, the way REMO used to handle the number
of model and time levels has not always been consistent. For example,
the index for the model level in the Fortran variable is not
neccessarily consistent with the model level itself. A simple example
would be a 2D variable where the index for the third dimension always is
1 although the model level would be, e.g., 27 for a 27 layer model. On
the other hand, variables like <code class="docutils literal notranslate"><span class="pre">FTKVM</span></code> and <code class="docutils literal notranslate"><span class="pre">FTKVH</span></code> are allocated
with KE levels but physically only reach from level 2 to KE and which
requires some shifting during the output. It is therefore usually a good
idea to explicitly specifiy the model level range with the argument
<code class="docutils literal notranslate"><span class="pre">kake</span></code> as seen in the example for the temperature. The argument
<code class="docutils literal notranslate"><span class="pre">ntime</span></code> will make sure that the fourth dimension is handled as a time
variable during output. In general, it is a good idea to look at the
module file <code class="docutils literal notranslate"><span class="pre">mo_memory_main.f90</span></code> for examples of how to add variable
of different dimensions and time levels. Note that although the pointers
that are delcared and are used to work with in the model, internally,
the pointers in the streams are all 4D pointers for consistent output
handling.</p>
<div class="section" id="in-and-output-streams">
<h2>In and Output Streams<a class="headerlink" href="#in-and-output-streams" title="Permalink to this headline">Â¶</a></h2>
<div class="line-block">
<div class="line">All fields that need input data or fields that should be written into
an output file require meta information for the IO process. In earlier
versions of REMO, this was handled using tables of names, codes, etc.
which where connected to the Fortran variable manually in a âputâ
routine, e.g., <code class="docutils literal notranslate"><span class="pre">putec4</span></code> or <code class="docutils literal notranslate"><span class="pre">puteca</span></code>. The netcdf IO make use of the
derived types which connect meta information with a data pointer so
that the IO prcoess can be handled more easily and dynamically. This
also has the advantage that fields are not statically allocated any
more but are allocated dynamically which makes memory management much
easier if the model should be applied at different resolutions.</div>
<div class="line">The most important stream that holds output data is called
<code class="docutils literal notranslate"><span class="pre">REMO_TABLE</span></code> and is organized in <code class="docutils literal notranslate"><span class="pre">mo_memory_main.f90</span></code>. This stream
is mainly created to hold all variables in an organized manner.
However, the data is not put into a file directly from the
<code class="docutils literal notranslate"><span class="pre">REMO_TABLE</span></code> but rather from an output stream that holds references
to this table. These output streams are organized in
<code class="docutils literal notranslate"><span class="pre">mo_memory_output.f90</span></code>. The output streams are created at the
beginning of the model run from the lists of variables that are
defined in the namelist <code class="docutils literal notranslate"><span class="pre">DATEN</span></code>. The output streams then will hold a
fixed list of references to the data that should go in a certain file.
This has the advantage that, at output time, data in an output streams
can be accessed easily and quickly without having to walk through the
whole <code class="docutils literal notranslate"><span class="pre">REMO_TABLE</span></code> again and again.</div>
<div class="line">The same is true for reading in data from a forcing file during the
run. The main table for boundary data is called <code class="docutils literal notranslate"><span class="pre">BOUNDARY_TABLE</span></code> and
it is organized in <code class="docutils literal notranslate"><span class="pre">mo_memory_boundary.f90</span></code>. This table holds all
variables that will hold boundary data during the run. They have two
timelevels since they will always hold the forcing data of two
consecutive a-files (e.g., with a 6 hour resolution). Although this
table is not very large, we still create an extra reference input
stream for this (the <code class="docutils literal notranslate"><span class="pre">a-stream</span></code> in <code class="docutils literal notranslate"><span class="pre">mo_memory_input.f90</span></code>) so that
data can be read in depending on the actual content of the a-file.
Similarly, restart data is read in by creating an f-stream that is
referencing memory in the <code class="docutils literal notranslate"><span class="pre">REMO_TABLE</span></code> stream to fill in data from
restart files.</div>
<div class="line">Note, that in <code class="docutils literal notranslate"><span class="pre">mo_memory_output.f90</span></code> also streams for monthly and
daily means as well as a table for standard deviations is created.
These tables allocate extra memory to hold and accumulate output data
for monthly and daily min/max and mean values.</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Lars Buntemeyer.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>